/* ================================================
   TRANSLATIONS â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø¬Ù…Ø©
================================================ */
const TRANSLATIONS = {
  ar: {
    login_title:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", login_btn:"Ø¯Ø®ÙˆÙ„", logout:"Ø®Ø±ÙˆØ¬",
    pin_placeholder:"Ø±Ù…Ø² PIN",
    menu_sale:"ğŸ›’ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹", menu_stock:"ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
    menu_customers:"ğŸ‘¥ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†", menu_users:"ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
    menu_reports:"ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„", menu_settings:"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
    back:"Ø§Ù„Ø±Ø¬ÙˆØ¹",
    sale_title:"ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨ÙŠØ¹",
    search_placeholder:"Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯",
    add_btn:"â• Ø¥Ø¶Ø§ÙØ©",
    col_item:"Ø³Ù„Ø¹Ø©", col_qty:"ÙƒÙ…ÙŠØ©", col_price:"Ø³Ø¹Ø±",
    col_total:"Ù…Ø¬Ù…ÙˆØ¹", col_options:"Ø®ÙŠØ§Ø±Ø§Øª",
    col_name:"Ø§Ù„Ø§Ø³Ù…", col_role:"Ø§Ù„Ø¯ÙˆØ±",
    paid_placeholder:"Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹",
    pay_btn:"âœ… ØªØ³Ø¯ÙŠØ¯", partial_btn:"ğŸ’° Ø¬Ø²Ø¦ÙŠ", debt_btn:"ğŸ“‹ Ø¯ÙŠÙ†",
    // Ù…Ø®Ø²ÙˆÙ†
    tab_families:"Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª", tab_brands:"Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª", tab_all_stock:"ÙƒÙ„ Ø§Ù„Ø³Ù„Ø¹",
    families_title:"ğŸ“ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª â€” Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬",
    brands_title:"ğŸ·ï¸ Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª â€” Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬",
    add_product_title:"â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯",
    all_products:"ğŸ“‹ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
    family_ph:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©...",
    brand_ph:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©...",
    add_family:"â• Ø¥Ø¶Ø§ÙØ©", add_brand:"â• Ø¥Ø¶Ø§ÙØ©",
    family_label:"Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©", brand_label:"Ø§Ù„Ù…Ø§Ø±ÙƒØ©",
    size_label:"Ø§Ù„Ø­Ø¬Ù… / Ø§Ù„Ù…Ù‚Ø§Ø³", barcode_label:"Ø¨Ø§Ø±ÙƒÙˆØ¯",
    price_label:"Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹", cost_label:"Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡",
    qty_label:"Ø§Ù„ÙƒÙ…ÙŠØ©", exp_label:"ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©",
    save_item:"ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬",
    stock_search_ph:"ğŸ” Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...",
    edit_btn:"ØªØ¹Ø¯ÙŠÙ„", del_btn:"Ù…Ø³Ø­",
    // ØªÙ‚Ø§Ø±ÙŠØ±
    tab_day:"Ø§Ù„ÙŠÙˆÙ…", tab_week:"Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹", tab_month:"Ø§Ù„Ø´Ù‡Ø±",
    tab_year:"Ø§Ù„Ø³Ù†Ø©", tab_all:"Ø§Ù„ÙƒÙ„",
    r_sales:"Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹", r_revenue:"Ø§Ù„Ù…Ø¯Ø§Ø®ÙŠÙ„",
    r_cost:"ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø±Ø§Ø¡", r_profit:"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­",
    debts_title:"ğŸ“‹ ØªØªØ¨Ø¹ Ø§Ù„Ø¯ÙŠÙˆÙ†",
    total_debts:"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†", debtors_count:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠÙ†",
    sales_log:"ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª",
    settle_btn:"ØªØ³ÙˆÙŠØ©",
    no_debts:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† ğŸ‰", no_sales:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª",
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    stab_app:"ğŸ–¥ï¸ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", stab_store:"ğŸª Ø§Ù„Ù…ØªØ¬Ø±",
    stab_print:"ğŸ–¨ï¸ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©", stab_system:"ğŸ”§ Ø§Ù„Ù†Ø¸Ø§Ù…",
    date_format:"ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®", time_format:"ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª",
    currency_label:"Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø©", lang_label:"Ù„ØºØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
    save_app:"ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
    logo_label:"Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±",
    upload_logo:"ğŸ“· ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±", remove_logo:"ğŸ—‘ï¸ Ø­Ø°Ù",
    shop_name:"Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±", phone_label:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
    address_label:"Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", welcome_label:"Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„ÙØ§ØªÙˆØ±Ø©",
    save_store:"ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±",
    invoice_num:"Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)",
    printer_label:"Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©", paper_size:"Ù…Ù‚Ø§Ø³ Ø§Ù„ÙˆØ±Ù‚",
    copies_label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø³Ø®",
    print_logo:"Ø·Ø¨Ø§Ø¹Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØ¬Ø±", print_name:"Ø·Ø¨Ø§Ø¹Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±",
    print_phone:"Ø·Ø¨Ø§Ø¹Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", print_welcome:"Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨",
    print_barcode:"Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª",
    print_cust_barcode:"Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ ÙˆØ±Ù‚Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†",
    save_print:"ğŸ’¾ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",
    auto_backup_title:"ğŸ’¾ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    auto_backup_desc:"ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª.",
    auto_backup_toggle:"ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ",
    manual_backup:"ğŸ“¥ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø¢Ù†",
    reset_btn:"ğŸ”´ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…",
    reset_warning:"âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŒ Ø§Ù„ÙÙˆØ§ØªÙŠØ±ØŒ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†ØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±) ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.",
    customer_ph:"Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†",
    username_ph:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    role_seller:"Ø¨Ø§Ø¦Ø¹", role_manager:"Ù…Ø¯ÙŠØ±",
    add_user:"â• Ø¥Ø¶Ø§ÙØ©",
    lang_preview:"Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸.",
    // Ø±Ø³Ø§Ø¦Ù„
    msg_select_user:"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹",
    msg_wrong_pin:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø² Ø®Ø§Ø·Ø¦",
    msg_saved:"âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_family_exists:"Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_brand_exists:"Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø±ÙƒØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_select_family:"Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹",
    msg_barcode_exists:"Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_item_updated:"Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ â€” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©!",
    msg_item_saved:"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_fill_all:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­!",
    msg_no_cart:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¨Ø©!",
    msg_low_balance:"Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
    msg_sold:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!",
    msg_change:"âœ… ØªÙ… Ø§Ù„Ø¨ÙŠØ¹!\nØ§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø²Ø¨ÙˆÙ†: ",
    msg_partial_ok:"âœ… Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ!\nÙ…Ø¯ÙÙˆØ¹: ",
    msg_partial_rem:"\nÙ…ØªØ¨Ù‚ÙŠ: ",
    msg_need_amount:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹",
    msg_covers_all:"Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØºØ·ÙŠ Ø§Ù„ÙƒÙ„ØŒ Ø§Ø³ØªØ®Ø¯Ù… 'ØªØ³Ø¯ÙŠØ¯'",
    msg_select_customer:"Ø§Ø®ØªØ± Ø²Ø¨ÙˆÙ†Ø§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„ÙŠÙ‡",
    msg_debt_ok:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† Ø¹Ù„Ù‰ ",
    msg_debt_amount:"\nØ§Ù„Ù…Ø¨Ù„Øº: ",
    msg_out_of_stock:"Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†ÙØ° Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!",
    msg_not_enough:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙ!",
    msg_not_found:"Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
    msg_enter_search:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø© Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯",
    msg_customer_exists:"Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹",
    msg_enter_customer:"Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†",
    msg_user_exists:"Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§",
    msg_pin_format:"Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­ ÙˆPIN Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…",
    msg_pin_4:"PIN ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù…",
    msg_cant_delete:"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
    msg_confirm_delete_user:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ",
    msg_confirm_delete:"Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ",
    msg_confirm_delete_customer:"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø¨ÙˆÙ†ØŸ",
    msg_confirm_delete_family:"Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ù…Ø§Ø±ÙƒØ§ØªÙ‡Ø§ Ø£ÙŠØ¶Ø§Ù‹.",
    msg_confirm_delete_brand:"Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø±ÙƒØ©ØŸ",
    msg_backup_done:"âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!",
    msg_backup_auto_on:"âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ.",
    msg_backup_auto_off:"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ.",
    msg_reset_confirm:"Ø§ÙƒØªØ¨ 'Ù†Ø¹Ù…' Ù„Ù„ØªØ£ÙƒÙŠØ¯:",
    msg_reset_done:"âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù….",
    msg_reset_cancel:"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.",
    settle_prompt:"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:",
    settle_ok:"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ ",
    settle_from:" Ù…Ù† ",
    no_stock:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº",
    no_families:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø§Ø¦Ù„Ø§Øª Ø¨Ø¹Ø¯",
    no_brands:"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø§Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯",
    no_customers:"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø¨Ø¹Ø¯",
  },

  fr: {
    login_title:"Connexion", login_btn:"Entrer", logout:"DÃ©connexion",
    pin_placeholder:"Code PIN",
    menu_sale:"ğŸ›’ Vente", menu_stock:"ğŸ“¦ Stock",
    menu_customers:"ğŸ‘¥ Clients", menu_users:"ğŸ‘¤ Utilisateurs",
    menu_reports:"ğŸ“Š Gestion", menu_settings:"âš™ï¸ ParamÃ¨tres",
    back:"Retour",
    sale_title:"Interface de vente",
    search_placeholder:"Nom ou code-barres",
    add_btn:"â• Ajouter",
    col_item:"Article", col_qty:"QtÃ©", col_price:"Prix",
    col_total:"Total", col_options:"Options",
    col_name:"Nom", col_role:"RÃ´le",
    paid_placeholder:"Montant payÃ©",
    pay_btn:"âœ… Payer", partial_btn:"ğŸ’° Partiel", debt_btn:"ğŸ“‹ CrÃ©dit",
    tab_families:"Familles", tab_brands:"Marques", tab_all_stock:"Tous les articles",
    families_title:"ğŸ“ Familles â€” Type de produit",
    brands_title:"ğŸ·ï¸ Marques â€” Famille de produit",
    add_product_title:"â• Ajouter un produit",
    all_products:"ğŸ“‹ Tous les produits",
    family_ph:"Entrer le nom de la famille...",
    brand_ph:"Entrer le nom de la marque...",
    add_family:"â• Ajouter", add_brand:"â• Ajouter",
    family_label:"Famille", brand_label:"Marque",
    size_label:"Taille / Format", barcode_label:"Code-barres",
    price_label:"Prix de vente", cost_label:"Prix d'achat",
    qty_label:"QuantitÃ©", exp_label:"Date d'expiration",
    save_item:"ğŸ’¾ Enregistrer",
    stock_search_ph:"ğŸ” Rechercher dans le stock...",
    edit_btn:"Modifier", del_btn:"Supprimer",
    tab_day:"Aujourd'hui", tab_week:"Semaine", tab_month:"Mois",
    tab_year:"AnnÃ©e", tab_all:"Tout",
    r_sales:"Ventes", r_revenue:"Revenus",
    r_cost:"CoÃ»t d'achat", r_profit:"BÃ©nÃ©fice net",
    debts_title:"ğŸ“‹ Suivi des dettes",
    total_debts:"Total dettes", debtors_count:"Nb dÃ©biteurs",
    sales_log:"ğŸ“œ Journal des opÃ©rations",
    settle_btn:"RÃ©gler",
    no_debts:"Pas de dettes ğŸ‰", no_sales:"Pas d'opÃ©rations",
    stab_app:"ğŸ–¥ï¸ Programme", stab_store:"ğŸª Boutique",
    stab_print:"ğŸ–¨ï¸ Impression", stab_system:"ğŸ”§ SystÃ¨me",
    date_format:"Format de date", time_format:"Format de l'heure",
    currency_label:"Symbole monÃ©taire", lang_label:"Langue",
    save_app:"ğŸ’¾ Sauvegarder",
    logo_label:"Logo de la boutique",
    upload_logo:"ğŸ“· Charger logo", remove_logo:"ğŸ—‘ï¸ Supprimer",
    shop_name:"Nom de la boutique", phone_label:"TÃ©lÃ©phone",
    address_label:"Adresse", welcome_label:"Message de bienvenue",
    save_store:"ğŸ’¾ Sauvegarder",
    invoice_num:"NumÃ©ro de facture",
    printer_label:"Imprimante", paper_size:"Format papier",
    copies_label:"Nombre de copies",
    print_logo:"Imprimer logo", print_name:"Imprimer nom boutique",
    print_phone:"Imprimer tÃ©lÃ©phone", print_welcome:"Imprimer message accueil",
    print_barcode:"Imprimer codes-barres produits",
    print_cust_barcode:"Imprimer code-barres client",
    save_print:"ğŸ’¾ Sauvegarder",
    auto_backup_title:"ğŸ’¾ Sauvegarde automatique",
    auto_backup_desc:"Activer la sauvegarde quotidienne automatique des donnÃ©es.",
    auto_backup_toggle:"Activer la sauvegarde automatique quotidienne",
    manual_backup:"ğŸ“¥ Sauvegarder maintenant",
    reset_btn:"ğŸ”´ RÃ©initialiser le systÃ¨me",
    reset_warning:"âš ï¸ Attention : Cette action supprimera toutes les donnÃ©es (produits, factures, clients, rapports) et remettra le programme Ã  son Ã©tat initial.",
    customer_ph:"Nom du client",
    username_ph:"Nom d'utilisateur",
    role_seller:"Vendeur", role_manager:"Directeur",
    add_user:"â• Ajouter",
    lang_preview:"La langue sera appliquÃ©e aprÃ¨s sauvegarde.",
    msg_select_user:"Veuillez sÃ©lectionner un utilisateur",
    msg_wrong_pin:"Utilisateur ou PIN incorrect",
    msg_saved:"âœ… SauvegardÃ© avec succÃ¨s!",
    msg_family_exists:"Cette famille existe dÃ©jÃ ",
    msg_brand_exists:"Cette marque existe dÃ©jÃ ",
    msg_select_family:"SÃ©lectionnez une famille d'abord",
    msg_barcode_exists:"Ce code-barres existe dÃ©jÃ ",
    msg_item_updated:"Produit existant â€” quantitÃ© mise Ã  jour!",
    msg_item_saved:"âœ… Produit ajoutÃ© avec succÃ¨s!",
    msg_fill_all:"Veuillez remplir tous les champs correctement!",
    msg_no_cart:"Aucun produit dans le panier!",
    msg_low_balance:"Montant payÃ© infÃ©rieur au total",
    msg_sold:"âœ… Vente enregistrÃ©e!",
    msg_change:"âœ… Vente!\nMonnaie Ã  rendre: ",
    msg_partial_ok:"âœ… Paiement partiel!\nPayÃ©: ",
    msg_partial_rem:"\nReste: ",
    msg_need_amount:"Entrez le montant partiel",
    msg_covers_all:"Le montant couvre tout, utilisez 'Payer'",
    msg_select_customer:"SÃ©lectionnez un client pour le crÃ©dit",
    msg_debt_ok:"âœ… CrÃ©dit enregistrÃ© pour ",
    msg_debt_amount:"\nMontant: ",
    msg_out_of_stock:"Produit en rupture de stock!",
    msg_not_enough:"Stock insuffisant!",
    msg_not_found:"Produit introuvable",
    msg_enter_search:"Entrez un nom ou code-barres",
    msg_customer_exists:"Ce client existe dÃ©jÃ ",
    msg_enter_customer:"Entrez le nom du client",
    msg_user_exists:"Cet utilisateur existe dÃ©jÃ ",
    msg_pin_format:"Entrez un nom valide et PIN Ã  4 chiffres",
    msg_pin_4:"Le PIN doit Ãªtre 4 chiffres",
    msg_cant_delete:"Impossible de supprimer cet utilisateur",
    msg_confirm_delete_user:"Confirmer la suppression de cet utilisateur?",
    msg_confirm_delete:"Supprimer ce produit?",
    msg_confirm_delete_customer:"Confirmer la suppression de ce client?",
    msg_confirm_delete_family:"Supprimer cette famille? Ses marques seront supprimÃ©es.",
    msg_confirm_delete_brand:"Supprimer cette marque?",
    msg_backup_done:"âœ… Sauvegarde tÃ©lÃ©chargÃ©e!",
    msg_backup_auto_on:"âœ… Sauvegarde automatique activÃ©e.",
    msg_backup_auto_off:"Sauvegarde automatique dÃ©sactivÃ©e.",
    msg_reset_confirm:"Tapez 'oui' pour confirmer:",
    msg_reset_done:"âœ… SystÃ¨me rÃ©initialisÃ©.",
    msg_reset_cancel:"OpÃ©ration annulÃ©e.",
    settle_prompt:"Entrez le montant payÃ©:",
    settle_ok:"âœ… Paiement enregistrÃ©: ",
    settle_from:" de ",
    no_stock:"Stock vide", no_families:"Pas encore de familles",
    no_brands:"Pas encore de marques", no_customers:"Pas encore de clients",
  },

  en: {
    login_title:"Login", login_btn:"Sign In", logout:"Logout",
    pin_placeholder:"PIN Code",
    menu_sale:"ğŸ›’ Sales", menu_stock:"ğŸ“¦ Stock",
    menu_customers:"ğŸ‘¥ Customers", menu_users:"ğŸ‘¤ Users",
    menu_reports:"ğŸ“Š Business", menu_settings:"âš™ï¸ Settings",
    back:"Back",
    sale_title:"Sales Interface",
    search_placeholder:"Name or barcode",
    add_btn:"â• Add",
    col_item:"Item", col_qty:"Qty", col_price:"Price",
    col_total:"Total", col_options:"Options",
    col_name:"Name", col_role:"Role",
    paid_placeholder:"Amount paid",
    pay_btn:"âœ… Pay", partial_btn:"ğŸ’° Partial", debt_btn:"ğŸ“‹ Credit",
    tab_families:"Families", tab_brands:"Brands", tab_all_stock:"All Items",
    families_title:"ğŸ“ Families â€” Product type",
    brands_title:"ğŸ·ï¸ Brands â€” Product family",
    add_product_title:"â• Add New Product",
    all_products:"ğŸ“‹ All Products",
    family_ph:"Enter family name...",
    brand_ph:"Enter brand name...",
    add_family:"â• Add", add_brand:"â• Add",
    family_label:"Family", brand_label:"Brand",
    size_label:"Size / Format", barcode_label:"Barcode",
    price_label:"Sale price", cost_label:"Purchase price",
    qty_label:"Quantity", exp_label:"Expiry date",
    save_item:"ğŸ’¾ Save Product",
    stock_search_ph:"ğŸ” Search stock...",
    edit_btn:"Edit", del_btn:"Delete",
    tab_day:"Today", tab_week:"Week", tab_month:"Month",
    tab_year:"Year", tab_all:"All",
    r_sales:"Sales", r_revenue:"Revenue",
    r_cost:"Purchase cost", r_profit:"Net profit",
    debts_title:"ğŸ“‹ Debt Tracking",
    total_debts:"Total debts", debtors_count:"Debtors",
    sales_log:"ğŸ“œ Operations Log",
    settle_btn:"Settle",
    no_debts:"No debts ğŸ‰", no_sales:"No operations",
    stab_app:"ğŸ–¥ï¸ Program", stab_store:"ğŸª Store",
    stab_print:"ğŸ–¨ï¸ Printing", stab_system:"ğŸ”§ System",
    date_format:"Date format", time_format:"Time format",
    currency_label:"Currency symbol", lang_label:"Language",
    save_app:"ğŸ’¾ Save Program Settings",
    logo_label:"Store logo",
    upload_logo:"ğŸ“· Upload logo", remove_logo:"ğŸ—‘ï¸ Remove",
    shop_name:"Store name", phone_label:"Phone number",
    address_label:"Address", welcome_label:"Invoice welcome message",
    save_store:"ğŸ’¾ Save Store Data",
    invoice_num:"Current invoice number",
    printer_label:"Printer", paper_size:"Paper size",
    copies_label:"Number of copies",
    print_logo:"Print store logo", print_name:"Print store name",
    print_phone:"Print phone number", print_welcome:"Print welcome message",
    print_barcode:"Print product barcodes",
    print_cust_barcode:"Print barcode on customer receipt",
    save_print:"ğŸ’¾ Save Print Settings",
    auto_backup_title:"ğŸ’¾ Operations Log & Auto Backup",
    auto_backup_desc:"Enable daily automatic backup of app data.",
    auto_backup_toggle:"Enable daily automatic backup",
    manual_backup:"ğŸ“¥ Backup Now",
    reset_btn:"ğŸ”´ Reset System",
    reset_warning:"âš ï¸ Warning: This will delete all data (products, invoices, customers, reports) and reset the program to its initial state.",
    customer_ph:"Customer name",
    username_ph:"Username",
    role_seller:"Seller", role_manager:"Manager",
    add_user:"â• Add",
    lang_preview:"Language will be applied after saving.",
    msg_select_user:"Please select a user",
    msg_wrong_pin:"Incorrect username or PIN",
    msg_saved:"âœ… Saved successfully!",
    msg_family_exists:"This family already exists",
    msg_brand_exists:"This brand already exists",
    msg_select_family:"Select a family first",
    msg_barcode_exists:"This barcode already exists",
    msg_item_updated:"Product exists â€” quantity updated!",
    msg_item_saved:"âœ… Product added successfully!",
    msg_fill_all:"Please fill all fields correctly!",
    msg_no_cart:"No products in cart!",
    msg_low_balance:"Amount paid is less than total",
    msg_sold:"âœ… Sale registered!",
    msg_change:"âœ… Sale done!\nChange for customer: ",
    msg_partial_ok:"âœ… Partial payment!\nPaid: ",
    msg_partial_rem:"\nRemaining: ",
    msg_need_amount:"Enter the partial amount",
    msg_covers_all:"Amount covers all, use 'Pay' instead",
    msg_select_customer:"Select a customer for credit",
    msg_debt_ok:"âœ… Credit registered for ",
    msg_debt_amount:"\nAmount: ",
    msg_out_of_stock:"Product out of stock!",
    msg_not_enough:"Insufficient stock!",
    msg_not_found:"Product not found",
    msg_enter_search:"Enter a name or barcode",
    msg_customer_exists:"Customer already exists",
    msg_enter_customer:"Enter customer name",
    msg_user_exists:"Username already exists",
    msg_pin_format:"Enter valid name and 4-digit PIN",
    msg_pin_4:"PIN must be 4 digits",
    msg_cant_delete:"Cannot delete this user",
    msg_confirm_delete_user:"Confirm deleting this user?",
    msg_confirm_delete:"Delete this product?",
    msg_confirm_delete_customer:"Confirm deleting this customer?",
    msg_confirm_delete_family:"Delete this family? Its brands will also be removed.",
    msg_confirm_delete_brand:"Delete this brand?",
    msg_backup_done:"âœ… Backup downloaded!",
    msg_backup_auto_on:"âœ… Automatic daily backup enabled.",
    msg_backup_auto_off:"Automatic backup disabled.",
    msg_reset_confirm:"Type 'yes' to confirm:",
    msg_reset_done:"âœ… System reset complete.",
    msg_reset_cancel:"Operation cancelled.",
    settle_prompt:"Enter amount paid:",
    settle_ok:"âœ… Payment recorded: ",
    settle_from:" from ",
    no_stock:"Stock is empty", no_families:"No families yet",
    no_brands:"No brands yet", no_customers:"No customers yet",
  }
};

function t(key) {
  const lang = DB.settings.lang || "ar";
  return (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) ||
         (TRANSLATIONS["ar"][key]) || key;
}

function applyTranslations() {
  const lang = DB.settings.lang || "ar";
  document.documentElement.lang = lang;
  document.documentElement.dir  = lang === "ar" ? "rtl" : "ltr";

  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
    const key = el.getAttribute("data-i18n-placeholder");
    el.placeholder = t(key);
  });
}

function previewLangChange(lang) {
  const note = document.getElementById("langNote");
  if (note) note.textContent = TRANSLATIONS[lang]?.lang_preview || t("lang_preview");
}

/* ================================================
   LOCAL DATABASE
================================================ */
let DB = JSON.parse(localStorage.getItem("POSDZ")) || {
  users:    [{ name: "Admin", pin: "1234", role: "manager", immutable: true }],
  settings: {
    name:"POS DZ", phone:"", addr:"", welcome:"",
    currency:"Ø¯Ø¬", lang:"ar",
    dateFormat:"DD-MM-YYYY", timeFormat:"24",
    logo:"",
    printer:"default", paperSize:"80mm", copies:1,
    printLogo:false, printShopName:true, printPhone:true,
    printWelcome:true, printBarcode:false, printCustBarcode:false,
    invoiceNum:1,
    autoBackup:false, lastBackup:""
  },
  families:  [],   // [{id, name}]
  brands:    [],   // [{id, name, familyId}]
  stock:     [],
  cart:      [],
  customers: [],
  debts:     [],
  sales:     []
};

/* ================================================
   DOM ELEMENTS
================================================ */
const loginScreen    = document.getElementById("loginScreen");
const userSelect     = document.getElementById("userSelect");
const pinInput       = document.getElementById("pin");
const mainApp        = document.getElementById("mainApp");
const usersModal     = document.getElementById("usersModal");
const usersTableBody = document.querySelector("#usersTable tbody");
const addUserForm    = document.getElementById("addUserForm");
const newUserName    = document.getElementById("newUserName");
const newUserPin     = document.getElementById("newUserPin");
const newUserRole    = document.getElementById("newUserRole");
const alertUserName  = document.getElementById("alertUserName");
const alertUserPin   = document.getElementById("alertUserPin");
const alertUserRole  = document.getElementById("alertUserRole");
const addUserInAlerts= document.getElementById("addUserInAlerts");
const stockList      = document.getElementById("stockList");
const sideMenu       = document.getElementById("sideMenu");
const menuBtn        = document.getElementById("menuBtn");
const currentTimeEl  = document.getElementById("currentTime");
const currentDateEl  = document.getElementById("currentDate");
const salePage       = document.getElementById("sale");
const cartTableBody  = document.getElementById("cart");
const searchInput    = document.getElementById("search");
const custSelect     = document.getElementById("custSelect");
const totalEl        = document.getElementById("total");

/* ================================================
   UTILITY
================================================ */
function saveDB() { localStorage.setItem("POSDZ", JSON.stringify(DB)); }
function getCurrency() { return DB.settings.currency || "Ø¯Ø¬"; }
function formatPrice(val) { return Number(val).toFixed(2) + " " + getCurrency(); }

function formatDate(isoStr) {
  if (!isoStr) return "";
  const d = new Date(isoStr);
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return (DB.settings.dateFormat||"DD-MM-YYYY")
    .replace("DD",dd).replace("MM",mm).replace("YYYY",yy);
}

function uid() { return Date.now().toString(36)+Math.random().toString(36).slice(2); }

function isSameDay(d1,d2){ return d1.toDateString()===d2.toDateString(); }
function isSameWeek(d1,d2){
  const sw=d=>{ const x=new Date(d); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; };
  return sw(d1).getTime()===sw(d2).getTime();
}
function isSameMonth(d1,d2){ return d1.getFullYear()===d2.getFullYear()&&d1.getMonth()===d2.getMonth(); }
function isSameYear(d1,d2){ return d1.getFullYear()===d2.getFullYear(); }

/* ================================================
   LOGIN
================================================ */
function renderUserSelect() {
  userSelect.innerHTML = `<option value="">â€” ${t("menu_users").replace(/[ğŸ‘¤ ]/g,"")} â€”</option>`;
  DB.users.forEach(u => {
    const o = document.createElement("option");
    o.value=u.name; o.textContent=u.name;
    userSelect.appendChild(o);
  });
}

function login() {
  const name = userSelect.value;
  const pin  = pinInput.value.trim();
  if (!name) { alert(t("msg_select_user")); return; }
  const user = DB.users.find(u=>u.name===name&&u.pin===pin);
  if (!user) { alert(t("msg_wrong_pin")); return; }
  localStorage.setItem("POSDZ_LOGGED", JSON.stringify(user));
  loginScreen.style.display="none";
  mainApp.style.display="block";
  applyHeader(); showSale(); startClock();
}

function logout() {
  localStorage.removeItem("POSDZ_LOGGED");
  loginScreen.style.display="flex";
  mainApp.style.display="none";
  sideMenu.classList.add("hidden");
}

function applyHeader() {
  document.getElementById("shopName").textContent = DB.settings.name||"POS DZ";
  const logo=DB.settings.logo;
  const hl=document.getElementById("headerLogo");
  if (logo){ hl.src=logo; hl.style.display="block"; }
  else hl.style.display="none";
}

/* ================================================
   SETTINGS
================================================ */
function loadSettings() {
  const s=DB.settings;
  document.getElementById("sDateFormat").value = s.dateFormat||"DD-MM-YYYY";
  document.getElementById("sTimeFormat").value = s.timeFormat||"24";
  document.getElementById("sCurrency").value   = s.currency||"Ø¯Ø¬";
  document.getElementById("sLang").value       = s.lang||"ar";
  document.getElementById("langNote").textContent = "";
  document.getElementById("sname").value    = s.name||"";
  document.getElementById("sphone").value   = s.phone||"";
  document.getElementById("saddr").value    = s.addr||"";
  document.getElementById("sWelcome").value = s.welcome||"";
  if (s.logo){ document.getElementById("logoPreview").src=s.logo; document.getElementById("logoPreview").style.display="block"; }
  document.getElementById("sInvoiceNum").value     = s.invoiceNum||1;
  document.getElementById("sPrinter").value        = s.printer||"default";
  document.getElementById("sPaperSize").value      = s.paperSize||"80mm";
  document.getElementById("sCopies").value         = s.copies||1;
  document.getElementById("sPrintLogo").checked    = !!s.printLogo;
  document.getElementById("sPrintShopName").checked= s.printShopName!==false;
  document.getElementById("sPrintPhone").checked   = s.printPhone!==false;
  document.getElementById("sPrintWelcome").checked = s.printWelcome!==false;
  document.getElementById("sPrintBarcode").checked = !!s.printBarcode;
  document.getElementById("sPrintCustBarcode").checked=!!s.printCustBarcode;
  document.getElementById("sAutoBackup").checked   = !!s.autoBackup;
  updateBackupStatus();
}

function saveSettingsApp() {
  const newLang = document.getElementById("sLang").value;
  DB.settings.dateFormat = document.getElementById("sDateFormat").value;
  DB.settings.timeFormat = document.getElementById("sTimeFormat").value;
  DB.settings.currency   = document.getElementById("sCurrency").value.trim()||"Ø¯Ø¬";
  DB.settings.lang       = newLang;
  saveDB();
  applyTranslations();
  alert(t("msg_saved"));
}

function saveSettingsStore() {
  DB.settings.name    = document.getElementById("sname").value.trim();
  DB.settings.phone   = document.getElementById("sphone").value.trim();
  DB.settings.addr    = document.getElementById("saddr").value.trim();
  DB.settings.welcome = document.getElementById("sWelcome").value.trim();
  saveDB(); applyHeader(); alert(t("msg_saved"));
}

function saveSettingsPrint() {
  DB.settings.invoiceNum       = parseInt(document.getElementById("sInvoiceNum").value)||1;
  DB.settings.printer          = document.getElementById("sPrinter").value;
  DB.settings.paperSize        = document.getElementById("sPaperSize").value;
  DB.settings.copies           = parseInt(document.getElementById("sCopies").value)||1;
  DB.settings.printLogo        = document.getElementById("sPrintLogo").checked;
  DB.settings.printShopName    = document.getElementById("sPrintShopName").checked;
  DB.settings.printPhone       = document.getElementById("sPrintPhone").checked;
  DB.settings.printWelcome     = document.getElementById("sPrintWelcome").checked;
  DB.settings.printBarcode     = document.getElementById("sPrintBarcode").checked;
  DB.settings.printCustBarcode = document.getElementById("sPrintCustBarcode").checked;
  saveDB(); alert(t("msg_saved"));
}

function switchSettingsTab(panel, btn) {
  document.querySelectorAll(".settings-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".stab").forEach(b=>b.classList.remove("active"));
  document.getElementById("settings"+panel.charAt(0).toUpperCase()+panel.slice(1)).classList.add("active");
  btn.classList.add("active");
}

function previewLogo(input) {
  const file=input.files[0]; if (!file) return;
  const r=new FileReader();
  r.onload=e=>{
    DB.settings.logo=e.target.result;
    document.getElementById("logoPreview").src=e.target.result;
    document.getElementById("logoPreview").style.display="block";
    saveDB(); applyHeader();
  };
  r.readAsDataURL(file);
}
function removeLogo() {
  DB.settings.logo="";
  document.getElementById("logoPreview").src="";
  document.getElementById("logoPreview").style.display="none";
  saveDB(); applyHeader();
}
function saveSettings() { saveSettingsStore(); }

/* ================================================
   SYSTEM â€” Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
================================================ */
function toggleAutoBackup(enabled) {
  DB.settings.autoBackup=enabled; saveDB();
  alert(enabled ? t("msg_backup_auto_on") : t("msg_backup_auto_off"));
  updateBackupStatus();
}

function updateBackupStatus() {
  const el=document.getElementById("backupStatus"); if (!el) return;
  if (DB.settings.autoBackup) {
    const last=DB.settings.lastBackup ? formatDate(DB.settings.lastBackup) : "â€”";
    el.textContent=`Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: ${last}`;
  } else { el.textContent=""; }
}

function manualBackup() {
  const data=JSON.stringify(DB,null,2);
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  const now=new Date();
  a.href=url;
  a.download=`POSDZ_backup_${now.toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
  DB.settings.lastBackup=now.toISOString();
  saveDB(); alert(t("msg_backup_done")); updateBackupStatus();
}

function checkAutoBackup() {
  if (!DB.settings.autoBackup) return;
  const last=DB.settings.lastBackup;
  const now=new Date();
  if (!last || !isSameDay(new Date(last),now)) {
    manualBackup();
  }
}

function confirmReset() {
  const confirmWord = DB.settings.lang==="fr"?"oui": DB.settings.lang==="en"?"yes":"Ù†Ø¹Ù…";
  const ans=prompt(t("msg_reset_confirm"));
  if (!ans || ans.trim().toLowerCase()!==confirmWord) { alert(t("msg_reset_cancel")); return; }
  const freshDB = {
    users:[{name:"Admin",pin:"1234",role:"manager",immutable:true}],
    settings:{
      name:"POS DZ",phone:"",addr:"",welcome:"",
      currency:"Ø¯Ø¬",lang:DB.settings.lang||"ar",
      dateFormat:"DD-MM-YYYY",timeFormat:"24",logo:"",
      printer:"default",paperSize:"80mm",copies:1,
      printLogo:false,printShopName:true,printPhone:true,
      printWelcome:true,printBarcode:false,printCustBarcode:false,
      invoiceNum:1,autoBackup:false,lastBackup:""
    },
    families:[],brands:[],stock:[],cart:[],
    customers:[],debts:[],sales:[]
  };
  DB=freshDB; saveDB();
  localStorage.removeItem("POSDZ_LOGGED");
  alert(t("msg_reset_done"));
  location.reload();
}

/* ================================================
   NAVIGATION
================================================ */
function hideAllPages(){ document.querySelectorAll(".page").forEach(p=>p.classList.remove("active")); }

function showSale(){
  hideAllPages(); salePage.classList.add("active");
  renderCustomerSelect(); sideMenu.classList.add("hidden");
}

function show(id){
  hideAllPages();
  const page=document.getElementById(id);
  if (page) page.classList.add("active");
  if (id==="reports")   renderReports();
  if (id==="settings")  { loadSettings(); }
  if (id==="alerts")    renderAlerts();
  if (id==="customers") renderCustomerList();
  if (id==="stock")     { renderFamilyList(); renderBrandList(); renderStock(); populateStockSelects(); }
  sideMenu.classList.add("hidden");
}

function goBack(){ showSale(); }

/* ================================================
   STOCK TAB NAVIGATION
================================================ */
function switchStockTab(panel, btn){
  document.querySelectorAll(".stock-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".sktab").forEach(b=>b.classList.remove("active"));
  document.getElementById("stock"+panel.charAt(0).toUpperCase()+panel.slice(1)).classList.add("active");
  btn.classList.add("active");
  if (panel==="all") { populateStockSelects(); renderStock(); }
  if (panel==="brands") { renderBrandList(); populateBrandFamilySelect(); }
  if (panel==="families") renderFamilyList();
}

/* ================================================
   FAMILIES â€” Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
================================================ */
function addFamily(){
  const name=document.getElementById("familyInput").value.trim();
  if (!name) return;
  if (DB.families.find(f=>f.name.toLowerCase()===name.toLowerCase())){
    alert(t("msg_family_exists")); return;
  }
  DB.families.push({id:uid(), name});
  document.getElementById("familyInput").value="";
  saveDB(); renderFamilyList(); populateStockSelects(); populateBrandFamilySelect();
}

function editFamily(id){
  const fam=DB.families.find(f=>f.id===id); if (!fam) return;
  const newName=prompt(t("edit_btn")+" â€” "+fam.name+":", fam.name);
  if (!newName||newName.trim()===fam.name) return;
  if (DB.families.find(f=>f.name.toLowerCase()===newName.trim().toLowerCase()&&f.id!==id)){
    alert(t("msg_family_exists")); return;
  }
  fam.name=newName.trim(); saveDB();
  renderFamilyList(); populateStockSelects(); populateBrandFamilySelect();
}

function deleteFamily(id){
  if (!confirm(t("msg_confirm_delete_family"))) return;
  DB.families=DB.families.filter(f=>f.id!==id);
  DB.brands=DB.brands.filter(b=>b.familyId!==id);
  saveDB(); renderFamilyList(); renderBrandList(); populateStockSelects(); populateBrandFamilySelect();
}

function renderFamilyList(){
  const list=document.getElementById("familyList");
  list.innerHTML="";
  if (!DB.families.length){
    list.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_families")}</li>`; return;
  }
  DB.families.forEach(fam=>{
    const brandsCount=DB.brands.filter(b=>b.familyId===fam.id).length;
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:10px 4px;border-bottom:1px solid #eee";
    li.innerHTML=`
      <span>ğŸ“ <strong>${fam.name}</strong> <span style="color:#6b7280;font-size:12px">(${brandsCount} ${t("tab_brands")})</span></span>
      <span>
        <button onclick="editFamily('${fam.id}')" style="padding:5px 10px;font-size:13px;background:#3b82f6">${t("edit_btn")}</button>
        <button onclick="deleteFamily('${fam.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444;margin-right:4px">${t("del_btn")}</button>
      </span>`;
    list.appendChild(li);
  });
}

/* ================================================
   BRANDS â€” Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª
================================================ */
function populateBrandFamilySelect(){
  const sel=document.getElementById("brandFamilySelect");
  sel.innerHTML=`<option value="">â€” ${t("family_label")} â€”</option>`;
  DB.families.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.id; o.textContent=f.name;
    sel.appendChild(o);
  });
}

function addBrand(){
  const name=document.getElementById("brandInput").value.trim();
  const familyId=document.getElementById("brandFamilySelect").value;
  if (!name) return;
  if (!familyId){ alert(t("msg_select_family")); return; }
  if (DB.brands.find(b=>b.name.toLowerCase()===name.toLowerCase()&&b.familyId===familyId)){
    alert(t("msg_brand_exists")); return;
  }
  DB.brands.push({id:uid(), name, familyId});
  document.getElementById("brandInput").value="";
  saveDB(); renderBrandList(); populateStockSelects();
}

function editBrand(id){
  const brand=DB.brands.find(b=>b.id===id); if (!brand) return;
  const newName=prompt(t("edit_btn")+" â€” "+brand.name+":", brand.name);
  if (!newName||newName.trim()===brand.name) return;
  brand.name=newName.trim(); saveDB();
  renderBrandList(); populateStockSelects();
}

function deleteBrand(id){
  if (!confirm(t("msg_confirm_delete_brand"))) return;
  DB.brands=DB.brands.filter(b=>b.id!==id);
  saveDB(); renderBrandList(); populateStockSelects();
}

function renderBrandList(){
  const list=document.getElementById("brandList");
  list.innerHTML="";
  if (!DB.brands.length){
    list.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_brands")}</li>`; return;
  }
  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©
  DB.families.forEach(fam=>{
    const famBrands=DB.brands.filter(b=>b.familyId===fam.id);
    if (!famBrands.length) return;
    const header=document.createElement("li");
    header.style.cssText="background:#f1f5f9;padding:8px 10px;font-weight:700;color:#1f2937;border-radius:6px;margin:6px 0 4px;list-style:none";
    header.textContent=`ğŸ“ ${fam.name}`;
    list.appendChild(header);
    famBrands.forEach(brand=>{
      const li=document.createElement("li");
      li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 4px 8px 16px;border-bottom:1px solid #eee";
      li.innerHTML=`
        <span>ğŸ·ï¸ <strong>${brand.name}</strong></span>
        <span>
          <button onclick="editBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#3b82f6">${t("edit_btn")}</button>
          <button onclick="deleteBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444;margin-right:4px">${t("del_btn")}</button>
        </span>`;
      list.appendChild(li);
    });
  });
  // Ù…Ø§Ø±ÙƒØ§Øª Ø¨Ø¯ÙˆÙ† Ø¹Ø§Ø¦Ù„Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
  const orphans=DB.brands.filter(b=>!DB.families.find(f=>f.id===b.familyId));
  if (orphans.length){
    const header=document.createElement("li");
    header.style.cssText="background:#fef3c7;padding:8px 10px;font-weight:700;border-radius:6px;margin:6px 0 4px;list-style:none";
    header.textContent="âš ï¸ Ø¨Ø¯ÙˆÙ† Ø¹Ø§Ø¦Ù„Ø©";
    list.appendChild(header);
    orphans.forEach(brand=>{
      const li=document.createElement("li");
      li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 4px 8px 16px;border-bottom:1px solid #eee";
      li.innerHTML=`
        <span>ğŸ·ï¸ ${brand.name}</span>
        <button onclick="deleteBrand('${brand.id}')" style="padding:5px 10px;font-size:13px;background:#ef4444">${t("del_btn")}</button>`;
      list.appendChild(li);
    });
  }
}

/* ================================================
   STOCK SELECTS â€” Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
================================================ */
function populateStockSelects(){
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø§Øª
  const typeEl=document.getElementById("type");
  if (!typeEl) return;
  const savedType=typeEl.value;
  typeEl.innerHTML=`<option value="">â€” ${t("family_label")} â€”</option>`;
  DB.families.forEach(f=>{
    const o=document.createElement("option");
    o.value=f.name; o.textContent=f.name; o.dataset.id=f.id;
    typeEl.appendChild(o);
  });
  if (savedType) typeEl.value=savedType;

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª â€” ØªØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
  updateBrandSelectByFamily();
}

function updateBrandSelectByFamily(){
  const typeEl=document.getElementById("type");
  const brandEl=document.getElementById("brand");
  if (!typeEl||!brandEl) return;
  const selectedFamName=typeEl.value;
  const fam=DB.families.find(f=>f.name===selectedFamName);
  const savedBrand=brandEl.value;

  brandEl.innerHTML=`<option value="">â€” ${t("brand_label")} â€”</option>`;
  const brands = fam ? DB.brands.filter(b=>b.familyId===fam.id) : DB.brands;
  brands.forEach(b=>{
    const o=document.createElement("option");
    o.value=b.name; o.textContent=b.name;
    brandEl.appendChild(o);
  });
  if (savedBrand) brandEl.value=savedBrand;
}

// Ø±Ø¨Ø· Ø­Ø¯Ø« ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø±ÙƒØ§Øª
document.addEventListener("DOMContentLoaded",()=>{
  const typeEl=document.getElementById("type");
  if (typeEl) typeEl.addEventListener("change", updateBrandSelectByFamily);
});

/* ================================================
   STOCK MANAGEMENT
================================================ */
function saveItem(){
  const type      = document.getElementById("type").value.trim();
  const brand     = document.getElementById("brand").value.trim();
  const size      = document.getElementById("size").value.trim();
  const barcode   = document.getElementById("barcode").value.trim();
  const price     = parseFloat(document.getElementById("price").value);
  const costPrice = parseFloat(document.getElementById("costPrice").value);
  const qty       = parseInt(document.getElementById("qty").value);
  const exp       = document.getElementById("exp").value;

  if (!type||!brand||!barcode||isNaN(price)||isNaN(costPrice)||isNaN(qty)){
    alert(t("msg_fill_all")); return;
  }

  const existing=DB.stock.find(i=>i.barcode===barcode);
  if (existing){ existing.qty+=qty; alert(t("msg_item_updated")); }
  else { DB.stock.push({type,brand,size,barcode,price,costPrice,qty,exp}); alert(t("msg_item_saved")); }

  ["type","brand","size","barcode","price","costPrice","qty","exp"].forEach(id=>{
    const el=document.getElementById(id);
    if (el.tagName==="SELECT") el.value=""; else el.value="";
  });
  saveDB(); renderStock();
}

function editItem(index){
  const item=DB.stock[index];
  const newPrice=prompt(t("price_label")+":", item.price);
  const newQty=prompt(t("qty_label")+":", item.qty);
  if (newPrice!==null&&!isNaN(newPrice)) item.price=parseFloat(newPrice);
  if (newQty!==null&&!isNaN(newQty))     item.qty=parseInt(newQty);
  saveDB(); renderStock();
}

function deleteItem(index){
  if (!confirm(t("msg_confirm_delete"))) return;
  DB.stock.splice(index,1); saveDB(); renderStock();
}

function renderStock(){
  stockList.innerHTML="";
  const q=(document.getElementById("stockSearch")?.value||"").toLowerCase();
  const list=q ? DB.stock.filter(i=>i.type.toLowerCase().includes(q)||i.brand.toLowerCase().includes(q)||i.barcode.includes(q)) : DB.stock;

  if (!list.length){ stockList.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_stock")}</li>`; return; }

  // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø«Ù… Ø§Ù„Ù…Ø§Ø±ÙƒØ©
  const grouped={};
  list.forEach(item=>{
    const key=`${item.type}||${item.brand}`;
    if (!grouped[key]) grouped[key]={type:item.type, brand:item.brand, items:[]};
    grouped[key].items.push(item);
  });

  Object.values(grouped).forEach(group=>{
    const header=document.createElement("li");
    header.style.cssText="background:#f1f5f9;padding:8px 12px;font-weight:700;border-radius:6px;margin:8px 0 4px;list-style:none";
    header.innerHTML=`ğŸ“ ${group.type} &nbsp;â€º&nbsp; ğŸ·ï¸ ${group.brand}`;
    stockList.appendChild(header);

    group.items.forEach(item=>{
      const realIndex=DB.stock.indexOf(item);
      const expired=item.exp&&new Date(item.exp)<new Date();
      const li=document.createElement("li");
      li.style.cssText="padding:8px 4px 8px 12px;border-bottom:1px solid #eee";
      li.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px">
          <div>
            ${item.size?`<span style="color:#6b7280">${item.size}</span> | `:""}
            Ø¨Ø§Ø±ÙƒÙˆØ¯: <code>${item.barcode}</code>
            | ${t("price_label")}: <strong>${formatPrice(item.price)}</strong>
            | ${t("qty_label")}: <strong style="color:${item.qty<5?"#ef4444":"#10b981"}">${item.qty}</strong>
            ${expired?`<span style="color:#ef4444;font-size:12px"> âš  Ù…Ù†ØªÙ‡ÙŠ</span>`:""}
          </div>
          <div>
            <button onclick="editItem(${realIndex})" style="padding:5px 10px;font-size:13px;background:#3b82f6">${t("edit_btn")}</button>
            <button onclick="deleteItem(${realIndex})" style="padding:5px 10px;font-size:13px;background:#ef4444;margin-right:4px">${t("del_btn")}</button>
          </div>
        </div>`;
      stockList.appendChild(li);
    });
  });
}

/* ================================================
   CUSTOMERS
================================================ */
function renderCustomerSelect(){
  custSelect.innerHTML=`<option value="">â€” ${t("no_customers").replace("Ø¨Ø¹Ø¯","").trim()} â€”</option>`;
  DB.customers.forEach(c=>{
    const o=document.createElement("option"); o.value=c.name; o.textContent=c.name;
    custSelect.appendChild(o);
  });
}

function addCustomer(){
  const name=document.getElementById("cname").value.trim();
  if (!name){ alert(t("msg_enter_customer")); return; }
  if (DB.customers.find(c=>c.name===name)){ alert(t("msg_customer_exists")); return; }
  DB.customers.push({name,debts:[]});
  document.getElementById("cname").value="";
  saveDB(); renderCustomerList(); renderCustomerSelect();
}

function renderCustomerList(){
  const clist=document.getElementById("clist");
  clist.innerHTML="";
  if (!DB.customers.length){ clist.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_customers")}</li>`; return; }
  DB.customers.forEach((c,index)=>{
    const totalDebt=(c.debts||[]).reduce((s,d)=>s+(d.remaining||0),0);
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid #eee";
    li.innerHTML=`
      <span><strong>${c.name}</strong>${totalDebt>0?` <span style="color:#ef4444;font-size:13px">(${formatPrice(totalDebt)})</span>`:""}</span>
      <button onclick="deleteCustomer(${index})" style="background:#ef4444;padding:5px 10px;font-size:13px">${t("del_btn")}</button>`;
    clist.appendChild(li);
  });
}

function deleteCustomer(index){
  if (confirm(t("msg_confirm_delete_customer"))){ DB.customers.splice(index,1); saveDB(); renderCustomerList(); renderCustomerSelect(); }
}

/* ================================================
   USER MANAGEMENT
================================================ */
function renderUsersTable(){
  usersTableBody.innerHTML="";
  DB.users.forEach((user,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${user.name}</td>
      <td>${"*".repeat(user.pin.length)}</td>
      <td>${user.role==="manager"?t("role_manager"):t("role_seller")}</td>
      <td>
        <button onclick="editUser(${index})" ${user.immutable?"disabled":""}>${t("edit_btn")}</button>
        <button onclick="deleteUser(${index})" ${user.immutable?"disabled":""} style="background:#ef4444">${t("del_btn")}</button>
      </td>`;
    usersTableBody.appendChild(tr);
  });
}

function addUser(e){
  e.preventDefault();
  const name=newUserName.value.trim(), pin=newUserPin.value.trim(), role=newUserRole.value;
  if (!name||pin.length!==4||!/^\d+$/.test(pin)){ alert(t("msg_pin_format")); return; }
  if (DB.users.find(u=>u.name===name)){ alert(t("msg_user_exists")); return; }
  DB.users.push({name,pin,role,immutable:false});
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); addUserForm.reset();
}

function editUser(index){
  const user=DB.users[index];
  const newName=prompt(t("edit_btn")+" "+t("col_name")+":",user.name)||user.name;
  const newPin=prompt("PIN:",user.pin)||user.pin;
  const newRole=prompt("manager/baker:",user.role)||user.role;
  if (newPin.length!==4||!/^\d+$/.test(newPin)){ alert(t("msg_pin_4")); return; }
  user.name=newName; user.pin=newPin; user.role=newRole;
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts();
}

function deleteUser(index){
  if (DB.users[index].immutable){ alert(t("msg_cant_delete")); return; }
  if (confirm(t("msg_confirm_delete_user"))){ DB.users.splice(index,1); saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); }
}

function renderAlerts(){
  const alertList=document.getElementById("alertList");
  alertList.innerHTML="";
  DB.users.forEach((user,index)=>{
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee";
    li.innerHTML=`
      <span><strong>${user.name}</strong> â€” ${user.role==="manager"?t("role_manager"):t("role_seller")}</span>
      <span>
        <button onclick="editUser(${index})" ${user.immutable?"disabled":""} style="font-size:13px;padding:5px 10px">${t("edit_btn")}</button>
        <button onclick="deleteUser(${index})" ${user.immutable?"disabled":""} style="background:#ef4444;font-size:13px;padding:5px 10px;margin-right:4px">${t("del_btn")}</button>
      </span>`;
    alertList.appendChild(li);
  });
}

function addUserInAlertsFunc(e){
  e.preventDefault();
  const name=alertUserName.value.trim(), pin=alertUserPin.value.trim(), role=alertUserRole.value;
  if (!name||pin.length!==4||!/^\d+$/.test(pin)){ alert(t("msg_pin_format")); return; }
  if (DB.users.find(u=>u.name===name)){ alert(t("msg_user_exists")); return; }
  DB.users.push({name,pin,role,immutable:false});
  saveDB(); renderUsersTable(); renderUserSelect(); renderAlerts(); addUserInAlerts.reset();
}

function closeUsersModal(){ usersModal.style.display="none"; }

/* ================================================
   SALE & CART
================================================ */
function renderSaleStock(){
  cartTableBody.innerHTML="";
  DB.cart.forEach((cItem,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${cItem.name}</td>
      <td>
        <button onclick="decreaseQty(${index})" style="padding:3px 10px">âˆ’</button>
        <strong> ${cItem.qty} </strong>
        <button onclick="increaseQty(${index})" style="padding:3px 10px">+</button>
      </td>
      <td>${formatPrice(cItem.price)}</td>
      <td>${formatPrice(cItem.price*cItem.qty)}</td>
      <td><button onclick="removeFromCart(${index})" style="background:#ef4444;padding:5px 10px;font-size:13px">${t("del_btn")}</button></td>`;
    cartTableBody.appendChild(tr);
  });
  updateTotal();
}

function increaseQty(index){
  const cartItem=DB.cart[index];
  const stockItem=DB.stock.find(s=>s.barcode===cartItem.barcode);
  if (stockItem&&cartItem.qty>=stockItem.qty){ alert(t("msg_not_enough")); return; }
  cartItem.qty+=1; saveDB(); renderSaleStock();
}

function decreaseQty(index){
  DB.cart[index].qty-=1;
  if (DB.cart[index].qty<=0) DB.cart.splice(index,1);
  saveDB(); renderSaleStock();
}

function addItem(){
  const val=searchInput.value.trim().toLowerCase();
  if (!val){ alert(t("msg_enter_search")); return; }
  const item=DB.stock.find(i=>i.type.toLowerCase().includes(val)||i.brand.toLowerCase().includes(val)||i.barcode.includes(val));
  if (!item){ alert(t("msg_not_found")); return; }
  if (item.qty<=0){ alert(t("msg_out_of_stock")); return; }
  const cartItem=DB.cart.find(c=>c.barcode===item.barcode);
  if (cartItem){
    if (cartItem.qty>=item.qty){ alert(t("msg_not_enough")); return; }
    cartItem.qty+=1;
  } else {
    DB.cart.push({name:`${item.type} ${item.brand}`, barcode:item.barcode, price:item.price, costPrice:item.costPrice, qty:1});
  }
  searchInput.value=""; saveDB(); renderSaleStock();
}

function removeFromCart(index){ DB.cart.splice(index,1); saveDB(); renderSaleStock(); }
function updateTotal(){ totalEl.textContent=formatPrice(DB.cart.reduce((s,i)=>s+i.price*i.qty,0)); }

/* ================================================
   PAYMENT
================================================ */
function getCartTotal(){ return DB.cart.reduce((s,i)=>s+i.price*i.qty,0); }

function deductStock(){
  DB.cart.forEach(cItem=>{
    const s=DB.stock.find(s=>s.barcode===cItem.barcode);
    if (s) s.qty-=cItem.qty;
  });
}

function buildSale(type,paid){
  const invoiceNum=DB.settings.invoiceNum||1;
  DB.settings.invoiceNum=invoiceNum+1;
  return {
    invoiceNum, date:new Date().toISOString(),
    customer:custSelect.value||"â€”",
    type, paid:paid||0, total:getCartTotal(),
    items:DB.cart.map(i=>({name:i.name,barcode:i.barcode,price:i.price,cost:i.costPrice||0,qty:i.qty}))
  };
}

function pay(){
  if (!DB.cart.length){ alert(t("msg_no_cart")); return; }
  const paidVal=parseFloat(document.getElementById("paid").value);
  const total=getCartTotal();
  if (!isNaN(paidVal)&&paidVal<total){ alert(t("msg_low_balance")); return; }
  const change=!isNaN(paidVal)?paidVal-total:0;
  deductStock();
  DB.sales.push(buildSale("ÙƒØ§Ù…Ù„",paidVal||total));
  DB.cart=[]; document.getElementById("paid").value="";
  saveDB();
  alert(change>0?t("msg_change")+formatPrice(change):t("msg_sold"));
  renderSaleStock(); renderReports();
}

function partial(){
  if (!DB.cart.length){ alert(t("msg_no_cart")); return; }
  const paidVal=parseFloat(document.getElementById("paid").value);
  const total=getCartTotal();
  if (isNaN(paidVal)||paidVal<=0){ alert(t("msg_need_amount")); return; }
  if (paidVal>=total){ alert(t("msg_covers_all")); return; }
  const remaining=total-paidVal;
  const customerName=custSelect.value||"â€”";
  const customer=DB.customers.find(c=>c.name===customerName);
  const debtRecord={date:new Date().toISOString(),total,paid:paidVal,remaining};
  if (customer){ customer.debts=customer.debts||[]; customer.debts.push(debtRecord); }
  deductStock();
  DB.sales.push(buildSale("Ø¬Ø²Ø¦ÙŠ",paidVal));
  DB.debts=DB.debts||[];
  DB.debts.push({customer:customerName,...debtRecord});
  DB.cart=[]; document.getElementById("paid").value="";
  saveDB();
  alert(t("msg_partial_ok")+formatPrice(paidVal)+t("msg_partial_rem")+formatPrice(remaining));
  renderSaleStock(); renderReports();
}

function toDebt(){
  if (!DB.cart.length){ alert(t("msg_no_cart")); return; }
  const customerName=custSelect.value;
  if (!customerName){ alert(t("msg_select_customer")); return; }
  const total=getCartTotal();
  const customer=DB.customers.find(c=>c.name===customerName);
  const debtRecord={date:new Date().toISOString(),total,paid:0,remaining:total};
  if (customer){ customer.debts=customer.debts||[]; customer.debts.push(debtRecord); }
  deductStock();
  DB.sales.push(buildSale("Ø¯ÙŠÙ†",0));
  DB.debts=DB.debts||[];
  DB.debts.push({customer:customerName,...debtRecord});
  DB.cart=[]; saveDB();
  alert(t("msg_debt_ok")+customerName+t("msg_debt_amount")+formatPrice(total));
  renderSaleStock(); renderReports();
}

/* ================================================
   REPORTS
================================================ */
let currentReportTab="daily";

function switchReportTab(tab,btn){
  currentReportTab=tab;
  document.querySelectorAll(".rtab").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  renderReports();
}

function filterSalesByPeriod(tab){
  const now=new Date();
  return (DB.sales||[]).filter(s=>{
    const d=new Date(s.date);
    if (tab==="daily")   return isSameDay(d,now);
    if (tab==="weekly")  return isSameWeek(d,now);
    if (tab==="monthly") return isSameMonth(d,now);
    if (tab==="yearly")  return isSameYear(d,now);
    return true;
  });
}

function renderReports(){
  const sales=filterSalesByPeriod(currentReportTab);
  let revenue=0,cost=0;
  sales.forEach(s=>s.items.forEach(i=>{ revenue+=i.price*i.qty; cost+=(i.cost||0)*i.qty; }));
  document.getElementById("rSales").textContent=sales.length;
  document.getElementById("rRevenue").textContent=formatPrice(revenue);
  document.getElementById("rCost").textContent=formatPrice(cost);
  document.getElementById("rProfit").textContent=formatPrice(revenue-cost);
  renderDebts(); renderSalesLog(sales);
}

function renderDebts(){
  const byCustomer={};
  (DB.debts||[]).forEach(d=>{
    if (!byCustomer[d.customer]) byCustomer[d.customer]=0;
    byCustomer[d.customer]+=d.remaining||0;
  });
  const totalDebt=Object.values(byCustomer).reduce((s,v)=>s+v,0);
  const debtCount=Object.keys(byCustomer).filter(k=>byCustomer[k]>0).length;
  document.getElementById("rTotalDebt").textContent=formatPrice(totalDebt);
  document.getElementById("rDebtCount").textContent=debtCount;
  const debtList=document.getElementById("debtList");
  debtList.innerHTML="";
  const entries=Object.entries(byCustomer).filter(([,v])=>v>0);
  if (!entries.length){ debtList.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_debts")}</li>`; return; }
  entries.forEach(([name,amount])=>{
    const li=document.createElement("li");
    li.style.cssText="display:flex;justify-content:space-between;align-items:center;padding:8px 4px;border-bottom:1px solid #eee";
    li.innerHTML=`
      <span>ğŸ‘¤ <strong>${name}</strong></span>
      <div style="display:flex;align-items:center;gap:8px">
        <span style="color:#ef4444;font-weight:700">${formatPrice(amount)}</span>
        <button onclick="settleDebt('${name}')" style="background:#10b981;padding:4px 10px;font-size:13px">${t("settle_btn")}</button>
      </div>`;
    debtList.appendChild(li);
  });
}

function settleDebt(customerName){
  const amount=prompt(t("settle_prompt"));
  if (!amount||isNaN(amount)||Number(amount)<=0) return;
  const pay=parseFloat(amount);
  let remaining=pay;
  (DB.debts||[]).forEach(d=>{
    if (d.customer===customerName&&d.remaining>0&&remaining>0){
      const deduct=Math.min(d.remaining,remaining);
      d.remaining-=deduct; d.paid+=deduct; remaining-=deduct;
    }
  });
  const customer=DB.customers.find(c=>c.name===customerName);
  if (customer){ let r2=pay; (customer.debts||[]).forEach(d=>{ if(d.remaining>0&&r2>0){const x=Math.min(d.remaining,r2);d.remaining-=x;r2-=x;} }); }
  saveDB();
  alert(t("settle_ok")+formatPrice(pay)+t("settle_from")+customerName);
  renderDebts();
}

function renderSalesLog(sales){
  const salesLog=document.getElementById("salesLog");
  salesLog.innerHTML="";
  if (!sales.length){ salesLog.innerHTML=`<li style="color:#6b7280;text-align:center">${t("no_sales")}</li>`; return; }
  const typeColor={"ÙƒØ§Ù…Ù„":"#10b981","Ø¬Ø²Ø¦ÙŠ":"#f59e0b","Ø¯ÙŠÙ†":"#ef4444"};
  [...sales].reverse().forEach(sale=>{
    const li=document.createElement("li");
    li.style.cssText="padding:8px 4px;border-bottom:1px solid #eee;font-size:14px";
    li.innerHTML=`
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:4px">
        <span>${sale.invoiceNum?`<strong>#${sale.invoiceNum}</strong> | `:""}
          <span style="color:${typeColor[sale.type]||"#374151"};font-weight:600">${sale.type}</span>
          | ğŸ‘¤ ${sale.customer}
        </span>
        <span style="font-weight:700">${formatPrice(sale.total)}</span>
      </div>
      <div style="color:#6b7280;font-size:12px">${formatDate(sale.date)}</div>`;
    salesLog.appendChild(li);
  });
}

/* ================================================
   CLOCK
================================================ */
function startClock(){
  function updateTime(){
    const now=new Date();
    const fmt=DB.settings.timeFormat||"24";
    const opts=fmt==="12"
      ?{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true}
      :{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false};
    currentTimeEl.textContent=now.toLocaleTimeString(undefined,opts);
    currentDateEl.textContent=formatDate(now.toISOString());
  }
  updateTime(); setInterval(updateTime,1000);
}

/* ================================================
   MENU
================================================ */
menuBtn.addEventListener("click",()=>sideMenu.classList.toggle("hidden"));
document.addEventListener("click",e=>{
  if (!sideMenu.contains(e.target)&&e.target!==menuBtn) sideMenu.classList.add("hidden");
});

/* ================================================
   INIT
================================================ */
addUserForm.addEventListener("submit",addUser);
addUserInAlerts.addEventListener("submit",addUserInAlertsFunc);

applyTranslations();
renderUsersTable();
renderUserSelect();
renderStock();
renderSaleStock();
renderCustomerSelect();
renderCustomerList();
renderFamilyList();
renderBrandList();

const logged=JSON.parse(localStorage.getItem("POSDZ_LOGGED"));
if (logged){
  loginScreen.style.display="none";
  mainApp.style.display="block";
  applyHeader(); showSale(); startClock();
  checkAutoBackup();
} else {
  loginScreen.style.display="flex";
  mainApp.style.display="none";
}
