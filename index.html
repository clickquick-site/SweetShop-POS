<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUPER_POS Pro | النسخة المتكاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sidebar-bg: #1a252f; --accent: #3498db; --danger: #e74c3c; --success: #2ecc71; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-brand { padding: 25px; text-align: center; font-size: 1.5rem; border-bottom: 1px solid #2c3e50; }
        .nav-item { padding: 15px 25px; color: #bdc3c7; cursor: pointer; display: flex; align-items: center; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: #2c3e50; color: white; border-right: 4px solid var(--accent); }
        .nav-item i { margin-left: 12px; width: 20px; }

        /* Main Layout */
        .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .page-sec { display: none; padding: 20px; height: 100%; overflow-y: auto; }
        .active-sec { display: block; }

        /* Forms & Cards */
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-success { background: var(--success); color: white; }
        .btn-primary { background: var(--accent); color: white; }

        /* POS UI */
        .pos-container { display: flex; gap: 20px; height: calc(100% - 100px); }
        .products-grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; align-content: start; }
        .product-card { background: white; border-radius: 10px; text-align: center; padding: 10px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .product-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .product-card img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        
        /* Table styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }
        .expiring-soon { background: #fff3cd; color: #856404; }

        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--sidebar-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card" style="width: 350px; text-align: center;">
            <i class="fas fa-lock fa-3x" style="color: var(--accent); margin-bottom: 15px;"></i>
            <h3>دخول النظام</h3>
            <input type="text" id="loginUser" placeholder="اسم المستخدم" style="margin-bottom: 10px;">
            <input type="password" id="loginPass" placeholder="كلمة المرور" style="margin-bottom: 15px;">
            <button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">دخول</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-brand"><i class="fas fa-store"></i> <span id="sideBrand">SUPER_POS</span></div>
        <nav>
            <div class="nav-item active" onclick="switchPage('pos')"><i class="fas fa-cash-register"></i>نقطة البيع</div>
            <div class="nav-item" onclick="switchPage('inventory')"><i class="fas fa-boxes"></i>المخزون والمنتجات</div>
            <div class="nav-item" onclick="switchPage('credits')"><i class="fas fa-user-clock"></i>ديون الزبائن</div>
            <div class="nav-item" onclick="switchPage('reports')"><i class="fas fa-chart-line"></i>التقارير المالية</div>
            <div class="nav-item" onclick="switchPage('settings')"><i class="fas fa-tools"></i>الإعدادات</div>
        </nav>
        <div class="nav-item" style="margin-top: auto; color: var(--danger);" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i>خروج</div>
    </aside>

    <div class="content">
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <img id="mainLogo" src="" style="height: 40px; border-radius: 5px; display: none;">
                <h3 id="topName" style="margin: 0;">نظام إدارة مبيعات الحلويات</h3>
            </div>
            <div id="digitalClock" style="font-weight: bold; color: var(--sidebar-bg);"></div>
        </header>

        <section id="pos" class="page-sec active-sec">
            <div class="pos-container">
                <div style="flex: 1.5; background: white; border-radius: 12px; padding: 15px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="barcodeScan" placeholder="امسح الباركود هنا..." autofocus onchange="handleBarcode(this.value)">
                    </div>
                    <div id="posGrid" class="products-grid"></div>
                </div>
                <div style="flex: 1; background: white; border-radius: 12px; display: flex; flex-direction: column;">
                    <div style="padding: 15px; background: var(--sidebar-bg); color: white; border-radius: 12px 12px 0 0;">الفاتورة الحالية</div>
                    <div id="cartItems" style="flex: 1; padding: 10px; overflow-y: auto;"></div>
                    <div style="padding: 15px; border-top: 2px dashed #eee;">
                        <input type="number" id="promoDiscount" placeholder="تخفيض (قيمة)" oninput="calcTotal()">
                        <div style="display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin: 10px 0;">
                            <span>الإجمالي:</span>
                            <span id="finalTotal">0.00</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn btn-success" onclick="processSale('cash')">دفع نقداً</button>
                            <button class="btn btn-primary" onclick="processSale('credit')" style="background: var(--warning);">إضافة للديون</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="inventory" class="page-sec">
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> إضافة منتج جديد</h3>
                <div class="grid-3">
                    <input type="text" id="p_name" placeholder="اسم المنتج">
                    <input type="text" id="p_barcode" placeholder="الباركود">
                    <input type="number" id="p_price" placeholder="سعر البيع">
                    <input type="number" id="p_stock" placeholder="الكمية الافتتاحية">
                    <input type="date" id="p_expiry" title="تاريخ نهاية الصلاحية">
                    <div style="border: 1px dashed #ccc; padding: 5px;">
                        <label style="font-size: 0.8rem;">صورة المنتج:</label>
                        <input type="file" id="p_img" accept="image/*" onchange="previewImg(this, 'preview')">
                    </div>
                </div>
                <img id="preview" style="height: 60px; margin-top: 10px; display: none; border-radius: 5px;">
                <button class="btn btn-success" style="margin-top: 15px;" onclick="saveProduct()">حفظ في المخزن</button>
            </div>
            <div class="card">
                <h3>قائمة المخزون</h3>
                <table id="stockTable">
                    <thead>
                        <tr><th>الصورة</th><th>المنتج</th><th>الباركود</th><th>الكمية</th><th>الصلاحية</th><th>السعر</th><th>إجراء</th></tr>
                    </thead>
                    <tbody id="stockList"></tbody>
                </table>
            </div>
        </section>

        <section id="credits" class="page-sec">
            <div class="card">
                <h3>سجل ديون الزبائن</h3>
                <table>
                    <thead><tr><th>اسم الزبون</th><th>المبلغ</th><th>التاريخ</th><th>الحالة</th></tr></thead>
                    <tbody id="creditList"></tbody>
                </table>
            </div>
        </section>

        <section id="settings" class="page-sec">
            <div class="card" style="max-width: 600px; margin: auto;">
                <h3>إعدادات المتجر الأساسية</h3>
                <label>اسم المحل (يظهر في الفاتورة):</label>
                <input type="text" id="set_name" style="margin-bottom: 15px;">
                <label>شعار المحل:</label>
                <input type="file" id="set_logo_file" onchange="previewImg(this, 'logo_preview')">
                <img id="logo_preview" style="height: 100px; margin: 15px 0; border: 1px solid #ddd; display: block;">
                <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات بالكامل</button>
            </div>
        </section>
    </div>

    <script>
        // قواعد البيانات المحلية
        let products = JSON.parse(localStorage.getItem('pos_products')) || [];
        let sales = JSON.parse(localStorage.getItem('pos_sales')) || [];
        let credits = JSON.parse(localStorage.getItem('pos_credits')) || [];
        let cart = [];

        // نظام الدخول
        function attemptLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if(u === 'admin' && p === '123') { // كلمة مرور افتراضية
                document.getElementById('loginOverlay').style.display = 'none';
                initApp();
            } else { alert("بيانات خاطئة!"); }
        }

        // تحويل الصور إلى نص (Base64) للتخزين
        function previewImg(input, targetId) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).src = e.target.result;
                document.getElementById(targetId).style.display = 'block';
            }
            reader.readAsDataURL(file);
        }

        // حفظ الإعدادات والشعار
        function saveSettings() {
            const name = document.getElementById('set_name').value;
            const logo = document.getElementById('logo_preview').src;
            localStorage.setItem('shop_name', name);
            localStorage.setItem('shop_logo', logo);
            initApp();
            alert("تم التحديث!");
        }

        function saveProduct() {
            const p = {
                id: Date.now(),
                name: document.getElementById('p_name').value,
                barcode: document.getElementById('p_barcode').value,
                price: parseFloat(document.getElementById('p_price').value),
                stock: parseInt(document.getElementById('p_stock').value),
                expiry: document.getElementById('p_expiry').value,
                img: document.getElementById('preview').src
            };
            products.push(p);
            localStorage.setItem('pos_products', JSON.stringify(products));
            updateInventoryUI();
            alert("تم الإضافة!");
        }

        function updateInventoryUI() {
            const list = document.getElementById('stockList');
            list.innerHTML = '';
            products.forEach(p => {
                const isExpiring = new Date(p.expiry) < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                list.innerHTML += `
                    <tr class="${isExpiring ? 'expiring-soon' : ''}">
                        <td><img src="${p.img}" style="height:40px;"></td>
                        <td>${p.name}</td>
                        <td>${p.barcode}</td>
                        <td>${p.stock}</td>
                        <td>${p.expiry}</td>
                        <td>${p.price} دج</td>
                        <td><button onclick="deleteProduct(${p.id})">حذف</button></td>
                    </tr>`;
            });
            renderPOSGrid();
        }

        function renderPOSGrid() {
            const grid = document.getElementById('posGrid');
            grid.innerHTML = '';
            products.forEach(p => {
                grid.innerHTML += `
                    <div class="product-card" onclick="addToCart(${p.id})">
                        <img src="${p.img}">
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="color:var(--danger);">${p.price} دج</div>
                    </div>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            if(p.stock <= 0) { alert("نفد المخزون!"); return; }
            cart.push({...p});
            calcTotal();
        }

        function calcTotal() {
            let total = cart.reduce((sum, item) => sum + item.price, 0);
            const disc = parseFloat(document.getElementById('promoDiscount').value) || 0;
            document.getElementById('finalTotal').innerText = (total - disc).toFixed(2);
            renderCart();
        }

        function renderCart() {
            const cDiv = document.getElementById('cartItems');
            cDiv.innerHTML = cart.map((item, idx) => `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${item.name}</span>
                    <span>${item.price} دج <i class="fas fa-times" onclick="removeFromCart(${idx})"></i></span>
                </div>
            `).join('');
        }

        function processSale(type) {
            const total = document.getElementById('finalTotal').innerText;
            if(type === 'credit') {
                const customer = prompt("اسم الزبون للمديونية:");
                if(customer) credits.push({name: customer, amount: total, date: new Date().toLocaleDateString()});
            }
            // تحديث المخزون
            cart.forEach(item => {
                const p = products.find(x => x.id === item.id);
                p.stock--;
            });
            localStorage.setItem('pos_products', JSON.stringify(products));
            localStorage.setItem('pos_credits', JSON.stringify(credits));
            cart = [];
            calcTotal();
            updateInventoryUI();
            alert("تمت العملية بنجاح!");
        }

        function switchPage(id) {
            document.querySelectorAll('.page-sec').forEach(s => s.classList.remove('active-sec'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active-sec');
            event.currentTarget.classList.add('active');
        }

        function initApp() {
            const name = localStorage.getItem('shop_name') || "لوازم الحلويات باتنة";
            const logo = localStorage.getItem('shop_logo');
            document.getElementById('sideBrand').innerText = name;
            document.getElementById('topName').innerText = name;
            document.getElementById('set_name').value = name;
            if(logo) {
                document.getElementById('mainLogo').src = logo;
                document.getElementById('mainLogo').style.display = 'block';
                document.getElementById('logo_preview').src = logo;
            }
            updateInventoryUI();
        }

        setInterval(() => { document.getElementById('digitalClock').innerText = new Date().toLocaleString('ar-DZ'); }, 1000);
    </script>
</body>
</html>
